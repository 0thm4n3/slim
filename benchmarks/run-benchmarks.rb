#!/usr/bin/env ruby

$:.unshift(File.join(File.dirname(__FILE__), '..', 'lib'), File.dirname(__FILE__))

require 'slim'
require 'context'

require 'benchmark'
require 'erubis'
require 'erb'
require 'haml'

class SlimBenchmarks
  def initialize(slow, iterations)
    @iterations = (iterations || 1000).to_i
    @benches    = []

    tpl_erb  = File.read(File.dirname(__FILE__) + '/view.erb')
    tpl_haml = File.read(File.dirname(__FILE__) + '/view.haml')
    tpl_slim = File.read(File.dirname(__FILE__) + '/view.slim')

    context  = Context.new
    context_binding = context.instance_eval { binding }

    erb         = ERB.new(tpl_erb)
    erubis      = Erubis::Eruby.new(tpl_erb)
    fast_erubis = Erubis::FastEruby.new(tpl_erb)
    temple_erb  = Temple::ERB::Template.new { tpl_erb }
    haml        = Haml::Engine.new(tpl_haml, :format => :html5)
    haml_ugly   = Haml::Engine.new(tpl_haml, :format => :html5, :ugly => true)
    slim        = Slim::Template.new { tpl_slim }

    tilt_erb        = Tilt::ERBTemplate.new { tpl_erb }
    tilt_erubis     = Tilt::ErubisTemplate.new { tpl_erb }
    tilt_temple_erb = Temple::ERB::Template.new { tpl_erb }
    tilt_haml       = Tilt::HamlTemplate.new(:format => :html5){ tpl_haml }
    tilt_haml_ugly  = Tilt::HamlTemplate.new(:format => :html5, :ugly => true){ tpl_haml }
    tilt_slim       = Slim::Template.new { tpl_slim }

    haml.def_method(context, :run_haml)
    haml_ugly.def_method(context, :run_haml_ugly)
    context.instance_eval %{
      def run_erb; #{erb.src}; end
      def run_erubis; #{erubis.src}; end
      def run_temple_erb; #{temple_erb.precompiled_template}; end
      def run_fast_erubis; #{fast_erubis.src}; end
      def run_slim; #{slim.precompiled_template}; end
    }

    bench('(1) erb')         { context.run_erb }
    bench('(1) erubis')      { context.run_erubis }
    bench('(1) fast erubis') { context.run_fast_erubis }
    bench('(1) temple erb')  { context.run_temple_erb }
    bench('(1) slim')        { context.run_slim }
    bench('(1) haml')        { context.run_haml }
    bench('(1) haml ugly')   { context.run_haml_ugly }

    bench('(2) erb')       { tilt_erb.render(context) }
    bench('(2) erubis')    { tilt_erubis.render(context) }
    bench('(2) temple erb'){ tilt_temple_erb.render(context) }
    bench('(2) slim')      { tilt_slim.render(context) }
    bench('(2) haml')      { tilt_haml.render(context) }
    bench('(2) haml ugly') { tilt_haml_ugly.render(context) }

    bench('(3) erb')         { erb.result(context_binding) }
    bench('(3) erubis')      { erubis.result(context_binding) }
    bench('(3) fast erubis') { fast_erubis.result(context_binding) }
    bench('(3) temple erb')  { temple_erb.render(context) }
    bench('(3) slim')        { slim.render(context) }
    bench('(3) haml')        { haml.render(context) }
    bench('(3) haml ugly')   { haml_ugly.render(context) }

    if slow
      bench('(4) erb')         { ERB.new(tpl_erb).result(context_binding) }
      bench('(4) erubis')      { Erubis::Eruby.new(tpl_erb).result(context_binding) }
      bench('(4) fast erubis') { Erubis::FastEruby.new(tpl_erb).result(context_binding) }
      bench('(4) temple erb')  { Temple::ERB::Template.new { tpl_erb }.render(context) }
      bench('(4) slim')        { Slim::Template.new { tpl_slim }.render(context) }
      bench('(4) haml')        { Haml::Engine.new(tpl_haml, :format => :html5).render(context) }
      bench('(4) haml ugly')   { Haml::Engine.new(tpl_haml, :format => :html5, :ugly => true).render(context) }
    end
  end

  def run
    puts "#{@iterations} Iterations"
    Benchmark.bmbm do |x|
      @benches.each do |name, block|
        x.report name.to_s do
          @iterations.to_i.times { block.call }
        end
      end
    end
    puts "
(1) Compiled benchmark. Template is parsed before the benchmark and
    generated ruby code is compiled into a method.
    This is the fastest evaluation strategy because it benchmarks
    pure execution speed of the generated ruby code.

(2) Compiled Tilt benchmark. Template is compiled with Tilt, which gives a more
    accurate result of the performance in production mode in frameworks like
    Sinatra, Ramaze and Camping. (Rails still uses its own template
    compilation.)

(3) Cached benchmark. Template is parsed before the benchmark.
    The ruby code generated by the template engine might be evaluated every time.
    This benchmark uses the standard API of the template engine.

(4) Uncached benchmark. Template is parsed every time.
    This is not the recommended way to use the template engine
    and Slim is not optimized for it. Activate this benchmark with 'rake bench slow=1'.   

Temple ERB is the ERB implementation using the Temple framework. It shows the
overhead added by the Temple framework compared to ERB.
"
  end

  def bench(name, &block)
    @benches.push([name, block])
  end
end

SlimBenchmarks.new(ENV['slow'], ENV['iterations']).run
